type: Test
spec:
  id: EPVfwDYIg
  name: git-bitbucket
  trigger:
    type: http
    httpRequest:
      method: POST
      url: https://gitbridge.aws.optimizor.app/bitbucket
      body: "{\n  \"actor\":{\n    \"nickname\":\"emmap1\",\n    \"account_id\":\"udfy9suggmzpswxc7n200y3c\",\n    \"display_name\":\"QT\",\n    \"uuid\":\"{a54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3}\",\n    \"links\":{\n      \"self\":{\n        \"href\":\"https://api.bitbucket.org/api/2.0/users/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n      },\n      \"html\":{\n        \"href\":\"https://api.bitbucket.org/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n      },\n      \"avatar\":{\n        \"href\":\"https://bitbucket-api-assetroot.s3.amazonaws.com/c/photos/2015/Feb/26/3613917261-0-emmap1-avatar_avatar.png\"\n      }\n    }\n  },\n  \"repository\":{\n    \"links\":{\n      \"self\":{\n        \"href\":\"https://api.bitbucket.org/api/2.0/repositories/bitbucket/bitbucket\"\n      },\n      \"html\":{\n        \"href\":\"https://api.bitbucket.org/bitbucket/bitbucket\"\n      },\n      \"avatar\":{\n        \"href\":\"https://api-staging-assetroot.s3.amazonaws.com/c/photos/2014/Aug/01/bitbucket-logo-2629490769-3_avatar.png\"\n      }\n    },\n    \"uuid\":\"{673a6070-3421-46c9-9d48-90745f7bfe8e}\",\n    \"full_name\":\"team_name/repo_name\",\n    \"name\":\"repo_name\",\n    \"scm\":\"git\",\n    \"is_private\":true\n  },\n  \"push\":{\n    \"changes\":[\n      {\n        \"new\":{\n          \"type\":\"branch\",\n          \"name\":\"name-of-branch\",\n          \"target\":{\n            \"type\":\"commit\",\n            \"hash\":\"709d658dc5b6d6afcd46049c2f332ee3f515a67d\",\n            \"author\":{\n              \"nickname\":\"emmap1\",\n              \"account_id\":\"udfy9suggmzpswxc7n200y3c\",\n              \"display_name\":\"QT\",\n              \"uuid\":\"{a54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3}\",\n              \"links\":{\n                \"self\":{\n                  \"href\":\"https://api.bitbucket.org/api/2.0/users/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"html\":{\n                  \"href\":\"https://api.bitbucket.org/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"avatar\":{\n                  \"href\":\"https://bitbucket-api-assetroot.s3.amazonaws.com/c/photos/2015/Feb/26/3613917261-0-emmap1-avatar_avatar.png\"\n                }\n              }\n            },\n            \"message\":\"new commit message\\n\",\n            \"date\":\"2015-06-09T03:34:49+00:00\",\n            \"parents\":[\n              {\n                \"type\":\"commit\",\n                \"hash\":\"1e65c05c1d5171631d92438a13901ca7dae9618c\",\n                \"links\":{\n                  \"self\":{\n                    \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commit/8cbbd65829c7ad834a97841e0defc965718036a0\"\n                  },\n                  \"html\":{\n                    \"href\":\"https://bitbucket.org/user_name/repo_name/commits/8cbbd65829c7ad834a97841e0defc965718036a0\"\n                  }\n                }\n              }\n            ],\n            \"links\":{\n              \"self\":{\n                \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commit/c4b2b7914156a878aa7c9da452a09fb50c2091f2\"\n              },\n              \"html\":{\n                \"href\":\"https://bitbucket.org/user_name/repo_name/commits/c4b2b7914156a878aa7c9da452a09fb50c2091f2\"\n              }\n            }\n          },\n          \"links\":{\n            \"self\":{\n              \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/refs/branches/master\"\n            },\n            \"commits\":{\n              \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commits/master\"\n            },\n            \"html\":{\n              \"href\":\"https://bitbucket.org/user_name/repo_name/branch/master\"\n            }\n          }\n        },\n        \"old\":{\n          \"type\":\"branch\",\n          \"name\":\"name-of-branch\",\n          \"target\":{\n            \"type\":\"commit\",\n            \"hash\":\"1e65c05c1d5171631d92438a13901ca7dae9618c\",\n            \"author\":{\n              \"nickname\":\"emmap1\",\n              \"account_id\":\"udfy9suggmzpswxc7n200y3c\",\n              \"display_name\":\"QT\",\n              \"uuid\":\"{a54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3}\",\n              \"links\":{\n                \"self\":{\n                  \"href\":\"https://api.bitbucket.org/api/2.0/users/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"html\":{\n                  \"href\":\"https://api.bitbucket.org/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"avatar\":{\n                  \"href\":\"https://bitbucket-api-assetroot.s3.amazonaws.com/c/photos/2015/Feb/26/3613917261-0-emmap1-avatar_avatar.png\"\n                }\n              }\n            },\n            \"message\":\"old commit message\\n\",\n            \"date\":\"2015-06-08T21:34:56+00:00\",\n            \"parents\":[\n              {\n                \"type\":\"commit\",\n                \"hash\":\"e0d0c2041e09746be5ce4b55067d5a8e3098c843\",\n                \"links\":{\n                  \"self\":{\n                    \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commit/9c4a3452da3bc4f37af5a6bb9c784246f44406f7\"\n                  },\n                  \"html\":{\n                    \"href\":\"https://bitbucket.org/user_name/repo_name/commits/9c4a3452da3bc4f37af5a6bb9c784246f44406f7\"\n                  }\n                }\n              }\n            ],\n            \"links\":{\n              \"self\":{\n                \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commit/b99ea6dad8f416e57c5ca78c1ccef590600d841b\"\n              },\n              \"html\":{\n                \"href\":\"https://bitbucket.org/user_name/repo_name/commits/b99ea6dad8f416e57c5ca78c1ccef590600d841b\"\n              }\n            }\n          },\n          \"links\":{\n            \"self\":{\n              \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/refs/branches/master\"\n            },\n            \"commits\":{\n              \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commits/master\"\n            },\n            \"html\":{\n              \"href\":\"https://bitbucket.org/user_name/repo_name/branch/master\"\n            }\n          }\n        },\n        \"links\":{\n          \"html\":{\n            \"href\":\"https://bitbucket.org/user_name/repo_name/branches/compare/c4b2b7914156a878aa7c9da452a09fb50c2091f2..b99ea6dad8f416e57c5ca78c1ccef590600d841b\"\n          },\n          \"diff\":{\n            \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/diff/c4b2b7914156a878aa7c9da452a09fb50c2091f2..b99ea6dad8f416e57c5ca78c1ccef590600d841b\"\n          },\n          \"commits\":{\n            \"href\":\"https://api.bitbucket.org/2.0/repositories/user_name/repo_name/commits?include=c4b2b7914156a878aa7c9da452a09fb50c2091f2&exclude=b99ea6dad8f416e57c5ca78c1ccef590600d841b\"\n          }\n        },\n        \"created\":false,\n        \"forced\":false,\n        \"closed\":false,\n        \"commits\":[\n          {\n            \"hash\":\"03f4a7270240708834de475bcf21532d6134777e\",\n            \"type\":\"commit\",\n            \"message\":\"commit message\\n\",\n            \"author\":{\n              \"nickname\":\"emmap1\",\n              \"account_id\":\"udfy9suggmzpswxc7n200y3c\",\n              \"display_name\":\"QT\",\n              \"uuid\":\"{a54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3}\",\n              \"links\":{\n                \"self\":{\n                  \"href\":\"https://api.bitbucket.org/api/2.0/users/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"html\":{\n                  \"href\":\"https://api.bitbucket.org/%7Ba54f16da-24e9-4d7f-a3a7-b1ba2cd98aa3%7D\"\n                },\n                \"avatar\":{\n                  \"href\":\"https://bitbucket-api-assetroot.s3.amazonaws.com/c/photos/2015/Feb/26/3613917261-0-emmap1-avatar_avatar.png\"\n                }\n              }\n            },\n            \"links\":{\n              \"self\":{\n                \"href\":\"https://api.bitbucket.org/2.0/repositories/user/repo/commit/03f4a7270240708834de475bcf21532d6134777e\"\n              },\n              \"html\":{\n                \"href\":\"https://bitbucket.org/user/repo/commits/03f4a7270240708834de475bcf21532d6134777e\"\n              }\n            }\n          }\n        ],\n        \"truncated\":false\n      }\n    ]\n  }\n}"
      headers:
      - key: Content-Type
        value: application/json
      - key: X-Event-Key
        value: repo:push
  specs:
  - selector: span[qualitytrace.span.type="general" name="Qualitytrace trigger"]
    assertions:
    - attr:name = "Qualitytrace trigger"
    - attr:qualitytrace.response.status = 200
    - attr:qualitytrace.span.type = "general"
  - selector: span[qualitytrace.span.type="http" name="/bitbucket" http.method="POST"]
    assertions:
    - attr:http.method = "POST"
    - attr:http.route = "/bitbucket"
    - attr:http.scheme = "http"
    - attr:http.status_code = 200
    - attr:name = "/bitbucket"
    - attr:net.host.name = "kubviz"
    - attr:qualitytrace.span.type = "http"
  - selector: span[qualitytrace.span.type="http" name="PostBitbucket" http.method="POST"]
    assertions:
    - attr:http.method = "POST"
    - attr:qualitytrace.span.name = "PostBitbucket"
    - attr:qualitytrace.span.type = "http"